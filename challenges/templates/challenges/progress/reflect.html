{% extends 'base.html' %}
{% block title %}{{ challenge.name }}{% endblock %}

{% load staticfiles %}
{% load resized %}
{% load widget_tweaks %}

{% block js %}
  <script src="{% static "js/challenges.js" %}"></script>
  {{ comment_form.media }}
{% endblock %}

{% block content %}
  {% url "challenges:comments:comments" challenge_id=challenge.id username=progress.student.username stage='reflect' as comment_url %}

  <h1>{{ challenge.name }} <small>By {{progress.student.username}}</small></h1>
  {% if challenge.draft %}
    <h2><small>We're improving this challenge. You can keep working on it, but keep an eye out for changes.</small></h2>
  {% endif %}
  {% include "challenges/progress/_nav.html" with stage="reflect" %}
  <div class="challenge-content">
    {% if not request.user.profile.is_mentor %}
      <header class="challenge-header">
        <h1>Document your design process</h1>
        <p>{{ challenge.reflect_subheader }}</p>
      </header>
    {% endif %}

    {% if request.user.profile.is_student and progress.completed %}
      <div class="panel white congratulations-panel">
        <div class="panel-body text-center">
          <div class="row">
            <div class="col-md-6 col-md-offset-3 congratulations-panel-content">
              <h2>Congratulations!</h2>
              <p>
                You just completed a design challenge! Now you can post a picture of your project to the Inspiration Gallery
                to share with the community.
              </p>
              <a href="{% url "challenges:examples" challenge_id=challenge.id %}" class="btn btn-primary">Go to the Inspiration Gallery</a>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="row">
      {% if request.user.profile.is_mentor %}
        {% include "_mentor_panel.html" with comment_url=comment_url %}
      {% else %}
        <div class="col-md-5">
          <div class="panel blue">
            <div class="panel-body">
              <p>You've made great progress on this challenge. I think you are ready to move on to the next step.</p>
              <p><strong>Reflect on your design.</strong></p>
            </div>
          </div>
        </div><!-- /column 1 -->
      {% endif %}

      <div class="col-md-1">
        <div class="avatar-container">
          {% include "_avatar.html" with profile=progress.student.profile width=50 height=50 crop='fill' %}
        </div>
      </div>

      <div class="col-md-6">
        {% if request.user.profile.is_mentor %}
          <h3>{{progress.student.username}}'s progress</h3>
        {% else %}
          {% if quiz_form %}
          {% url "challenges:quizzes:quizzes" challenge_id=challenge.id username=progress.student.username stage='reflect' as action_url %}
          <div class="panel panel-bubble teal right reflect-quiz-box edp-comments">
            <div class="panel-body">
              <h1>Reflect Quiz</h1>
              <p>You've finished your challenge. Take the quiz and see how much you've learned!</p>
              <form method="POST" action="{{ action_url }}">
                {% csrf_token %}
                {{ quiz_form }}
                <input type="submit" class="btn btn-primary pull-right" data-debounce="true" />
              </form>
            </div>
          </div>
          {% else %}
          <div class="panel panel-bubble teal right reflect-box edp-comments">
            <div class="panel-body">
              <h1>Reflect</h1>
              <p>Are you finished with your project? Reflect on your work by answering a question below! Then you'll be able to share your design in the <a href="{% url "challenges:examples" challenge_id=challenge.id %}"><strong>Inspiration Gallery</strong></a>.</p>

                <ul class="challenge-reflect-questions" style="display: none;">
                  {% for question in challenge.reflect_questions.all %}
                    <li>{{ question }}</li>
                  {% endfor %}
                </ul>

                <div class="reflect-question">
                  <h3 class="question"></h3>
                  <p class="refresh" title="answer a different question">
                    <span class="glyphicon glyphicon-refresh"></span> Try another question.
                  </p>
                </div>

                {% if request.user.profile.is_student %}
                  <form method="POST" action="{{ comment_url }}">
                    {% csrf_token %}
                    {{ comment_form.text|attr:"placeholder:Write your reflection here. You can also add a photo or video below." }}
                    {{ comment_form.visual_media }}
                    {{ comment_form.question_text|add_class:'question-text' }}
                    <input type="submit" class="btn btn-primary pull-right" data-debounce="true" />
                  </form>
                {% else %}
                  <form>
                    {{ comment_form.text|attr:"disabled:disabled" }}
                    {{ comment_form.visual_media|attr:"disabled:disabled" }}
                    <input type="submit" disabled="disabled" class="btn btn-primary pull-right" />
                  </form>
                {% endif %}
            </div>
          </div>
          {% endif %}
        {% endif %}

        {% for comment in comments %}
          {% include "_comment.html" %}
        {% endfor %}
      </div><!-- /col 2 -->

    </div><!-- row -->

    {% include "_guide.html" %}

  </div><!-- content -->

{% endblock %}
