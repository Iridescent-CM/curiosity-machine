{% load cmtemplatetags %}
{% load array %}

{% if comment.user.profile.is_mentor %}
  <span class="mentor-comment">MENTOR MESSAGE</span>
  <span class="comment-date">{{ comment.created|timesince }}</span>
  <div class="mentor-info comment">
    <a href="{% url 'profiles:mentor_profile' comment.user.username %}">{% include "_avatar.html" with profile=comment.user.profile width=50 height=50 crop='fit' %}</a>
    <p><a href="{% url 'profiles:mentor_profile' comment.user.username %}">{{comment.user.username}}</a><br><strong>Mentor</strong></p>
  </div>
  <div class="panel panel-bubble blue comment">
    <div class="panel-body">
      {% include "_comment_content.html" %}
      {% if request.user == comment.user %}
      <form action="{% url "challenges:comments:delete_comment" challenge_id=challenge.id username=progress.student.username comment_id=comment.id stage=comment.get_stage_display %}" method="POST">
        {% csrf_token %}
        <button type="submit" value="" class="btn btn-comment-heading pull-right glyphicon glyphicon-trash" data-confirm="This will delete your post. Are you sure?"></button>
      </form>
      {% if comment.text %}
          <button class="btn pull-right btn-comment-heading margin-r-55 glyphicon glyphicon-edit" data-toggle="modal" data-target="#edit_text_modal{{comment.id}}">
          </button>
          {% url "challenges:comments:edit_comment" challenge_id=challenge.id username=progress.student.username comment_id=comment.id stage=comment.get_stage_display as theurl %}
          {% include "_edit_text_modal.html" with url=theurl id=comment.id comment_form=comment_forms|element_by_index:comment.id %}
        {% endif %}
      {% endif %}
    </div>
  </div>
{% else %}
  <span class="comment-date">{{ comment.created|timesince }}</span>
  <div class="panel panel-comment comment">
    <div class="panel-heading">
      <h3 class="panel-title">{{ comment.get_stage_display }}</h3>
    </div>
    <div class="panel-body paper">
      {% include "_comment_content.html" %}

    {% if request.user == comment.user %}
      {% if not comment.is_featured_as_example %}
        <form action="{% url "challenges:comments:delete_comment" challenge_id=challenge.id username=progress.student.username comment_id=comment.id stage=comment.get_stage_display %}" method="POST">
        {% csrf_token %}
        <button type="submit" value="" class="btn btn-comment-heading pull-right glyphicon glyphicon-trash" data-confirm="This will delete your post. Are you sure?"></button>
        </form>

        {% if comment.text %}
          <button class="btn pull-right btn-comment-heading margin-r-55 glyphicon glyphicon-edit" data-toggle="modal" data-target="#edit_text_modal{{comment.id}}">
          </button>
          {% url "challenges:comments:edit_comment" challenge_id=challenge.id username=progress.student.username comment_id=comment.id stage=comment.get_stage_display as theurl %}
          {% include "_edit_text_modal.html" with url=theurl id=comment.id comment_form=comment_forms|element_by_index:comment.id %}
        {% endif %}
      {% endif %}
    {% endif %}
      {% if request.user.profile.is_mentor and comment.get_stage_display == 'reflect'%}{% if comment.image or comment.video %}
      {% if comment.is_featured_as_example %}
        <form name="unfeature" class="ajax-and-refresh-form" action="{% url "challenges:comments:feature_as_example" challenge_id=challenge.id username=progress.student.username stage='build' comment_id=comment.id %}" method="DELETE">
          {% csrf_token %}
          <input type="submit" value="Unfeature {% if comment.video %}video{% else %}image{% endif %}" class="btn pull-right btn-xs">
        </form>
      {% else %}
        {# display a button so that the mentor can feature this comment's media on the inspiration page #}
        <form name="feature_as_example" class="ajax-and-refresh-form" action="{% url "challenges:comments:feature_as_example" challenge_id=challenge.id username=progress.student.username stage='build' comment_id=comment.id %}" method="POST">
          {% csrf_token %}
          <input type="submit" value="Feature {% if comment.video %}video{% else %}image{% endif %} as example" class="btn pull-right btn-xs btn-primary">
        </form>
      {% endif %}
    {% endif %}{% endif %}
    </div>
  </div>
{% endif %}
