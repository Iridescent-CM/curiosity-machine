{% extends "profiles/profile_form.html" %}
{% load bootstrap4 %}
{% load pick_action %}
{% load staticfiles %}

{% block js %}
  {{ form.media|add:formset.media }}
{% endblock %}

{% block cards %}
  {% with SHOW_REQUIRED=True %}
  <form action="{% pick_action form edit="families:edit_profile" create="families:create_profile" %}" method="POST" novalidate>
    {% csrf_token %}

    <div class="card cm-info-card mb-5">
      <div class="card-header text-center p-3">
        <h4 class="card-title">Profile Info</h4>
        <small class="text-muted">* Please fill out all fields marked with an asterisk</small>
      </div>
      <div class="card-body">
        <div class="text-center avatar-settings">
          {% block avatar %}
            {% include "profiles/_avatar.html" with profile=request.user.profile width=80 height=80 crop='thumb' gravity='faces' classes='rounded-circle' %}
          {% endblock %}
          {% form_group form.image_url field_class="btn btn-primary" %}
        </div>
        {% email_form_group form.email email=email %}
        {% form_group form.phone %}
        {% form_group form.country %}
        {% comment %} location should probably be a compound widget to encapsulate the following sort of thing {% endcomment %}
        {% if form.country.value == "US" %}
        {% form_group form.state required=True %}
        {% else %}
        {% form_group form.state group_style="display:none;" required=True %}
        {% endif %}
        {% form_group form.city %}
        {% if form.instance and form.instance.pk %}
        <a class="btn btn-secondary" href="{% url "account_change_password"%}">Change password</a>
        {% endif %}
        {% if form.instance and form.instance.pk %}
        <input type="submit" class="btn btn-primary float-right" value="Save">
        {% endif %}
      </div>
    </div>

    <div class="card cm-info-card">
      <div class="card-header text-center p-3">
        <h4 class="card-title">Family Members</h4>
        <small class="text-muted">
          * Please fill out all fields marked with an asterisk<br/>
          One parent and one child required, six family members max
        </small>
      </div>
      <div class="card-body">
        {{ formset.management_form }}
        {% for error in formset.non_form_errors %}
          <div class="alert alert-danger alert-dismissable show" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            {{ error }}
          </div>
        {% endfor %}
        {% for form in formset %}
          {% include "families/_familymember_inline.html" with form=form %}
        {% endfor %}
        <script data-formset="familymember_set" type="text/x-template">
          {% include "families/_familymember_inline.html" with form=formset.empty_form %}
        </script>
        <button class="btn btn-secondary" data-formset-add="familymember_set">Add family member</button>
        <input type="submit" class="btn btn-primary float-right" value="Save">
      </div>
    </div>
  </form>
  {% endwith %}
{% endblock %}
