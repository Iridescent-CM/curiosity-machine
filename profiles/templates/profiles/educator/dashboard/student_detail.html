{% extends "curiositymachine/layout/base.html" %}
{% load staticfiles %}
{% block title %}Curiosity Machine - Student Progress{% endblock %}
{% block body-classes %}educator-dashboard{% endblock %}

{% block content %}

{% include 'profiles/educator/dashboard/_header.html' %}

<div class="container">
  {% url "profiles:educator_dashboard_students" as base_url %}
  {% include 'profiles/educator/dashboard/_navigation.html' with membership_selection_base_url=base_url%}

  <div class="row">
    <div class="col-md-12">
      <h2>{{ student.username }}'s Progress</h2>
    </div>
  </div>
</div>

<div class="container">
  <div class="row m-b-lg">

    <div class="col-md-3">
      <div class="card card-module">
        <div class="card-block card-block-title text-center">
          <div class="card-avatar">
            {% include "_avatar.html" with profile=student.profile width=60 height=60 crop='thumb' gravity='faces' %}
          </div>
          {% if student.first_name or student.last_name %}
          {{ student.first_name }}
          <br>
          {{ student.last_name }}
          {% else %}
          <em>No name provided</em>
          {% endif %}
          <br>
          {{ student.username }}
        </div>
        <div class="card-block">
          <p>
            Started: <strong>{{ progresses|length }}</strong>
            <br>
            Completed: <strong>{{ completed_count }}</strong>
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      {% for progress in progresses %}
      <div class="card-progress m-b">
        <div class="card-block-title">
          <h3 class="card-title">{{ progress.challenge.name }}</h3>
          <a href="{% url "profiles:educator_dashboard_students" %}" class="a-secondary">View all students &rarr;</a>
        </div>
        <div class="card-block">

          <div class="row progress-details">
            <div class="col-md-4 m-b">
              <span class="progress-type">latest post</span>
              <br>
              {% if progress.latest_student_comment %}
              {{ progress.latest_student_comment.created|date:"l, M d" }} {% comment %}<span class="tag tag-pill tag-success">TODAY</span></p>{% endcomment %}
              {% else %}
              <em>No posts yet</em>
              {% endif %}
            </div>
            <div class="col-md-4 m-b">
              <span class="progress-type">online mentor</span>
              <br>
              {% if progress.mentor %}
              {{ progress.mentor.username }}
              {% else %}
              No mentor
              {% endif %}
            </div>
            <div class="col-md-4 m-b">
              <span class="progress-type">total posts</span>
              <br>
              {{ progress.total_student_comments }}
            </div>
          </div>
        </div>

        <div class="graph" data-pid="{{ progress.id }}"></div>

        <div class="card-block">
          <a href="{% url "challenges:challenge_progress" challenge_id=progress.challenge_id username=student.username %}" class="btn btn-primary">View Process &rarr;</a>
        </div>
      </div>
      {% empty %}
      <p>{{ student.username }} hasn't started any design challenges yet</p>
      {% endfor %}

    </div>
  </div>
</div>

{% endblock %}

{% block js %}
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="{% static "js/progress_chart.js" %}"></script>
  <script>
      var chart = progressChart();

      function graphAll (err, data) {

        var entries = d3.nest()
          .key(function(d) { return d["challenge_progress_id"]; })
          .sortValues(function(a, b) {
            return d3.ascending(a["created"], b["created"])
          })
          .entries(data);
        
        d3.selectAll(".graph")
          .data(
            entries,
            function(d) { 
              var key = d ? d['key'] : this.getAttribute('data-pid');
              return key;
            })
          .call(chart);
      }

      d3.json("{{ graph_data_url|safe }}", graphAll);
  </script>
{% endblock %}
